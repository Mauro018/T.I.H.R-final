{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad칤sticas | Panel Empresa</title>
    <link rel="stylesheet" href="{% static 'Empresas/css/styles3.css' %}?v=5">
    <link rel="stylesheet" href="{% static 'Empresas/css/estadisticas.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside>
            <h2>Dashboard de Empresa</h2>
            <nav>
                <ul>
                    <li><a href="{% url 'dashboardEmpresa' %}">Inicio</a></li>
                    <li><a href="{% url 'usuarios' %}">Gesti칩n de usuarios</a></li>
                    <li><a href="{% url 'GestiProductos' %}">Gesti칩n de productos</a></li>
                    <li><a href="{% url 'inventario' %}">Inventario</a></li>
                    <li><a href="{% url 'empresa_ideas' %}">Gesti칩n de ideas</a></li>
                    <li><a href="{% url 'empresa_comentarios' %}">Gesti칩n de comentarios</a></li>
                    <li><a href="{% url 'gestion_pagos' %}">Gesti칩n de pagos</a></li>
                    <li><a href="{% url 'gestion_pedidos' %}">Gesti칩n de pedidos</a></li>
                    <li><a href="{% url 'estadisticas' %}">Estad칤sticas</a></li>
                </ul>
            </nav>
            <a href="{% url 'logout' %}" class="logout-button">Cerrar sesi칩n</a>
        </aside>

        <!-- Main Content -->
        <main>
            <header>
                <h1><i class="fas fa-chart-line"></i> Estad칤sticas del Negocio</h1>
                <button class="btn-refresh" onclick="actualizarEstadisticas()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </header>

            <!-- Tarjetas de Estad칤sticas Principales -->
            <div class="stats-grid">
                <div class="stat-card" data-animate="fade-in">
                    <div class="stat-icon usuarios">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Usuarios Totales</h3>
                        <p class="stat-number" data-count="{{ total_usuarios }}">0</p>
                        <p class="stat-label">{{ usuarios_activos }} activos</p>
                        <div class="progress-bar">
                            <div class="progress-fill usuarios-fill" style="width: {{ usuarios_activos|default:0 }}{{ total_usuarios|default:1 }}%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card" data-animate="fade-in" style="animation-delay: 0.1s">
                    <div class="stat-icon productos">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Productos</h3>
                        <p class="stat-number" data-count="{{ total_productos }}">0</p>
                        <p class="stat-label">{{ total_inventario }} unidades en total</p>
                        <div class="progress-bar">
                            <div class="progress-fill productos-fill" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card" data-animate="fade-in" style="animation-delay: 0.2s">
                    <div class="stat-icon pedidos">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Pedidos Totales</h3>
                        <p class="stat-number" data-count="{{ total_pedidos }}">0</p>
                        <p class="stat-label">{{ pedidos_entregado }} entregados</p>
                        <div class="progress-bar">
                            <div class="progress-fill pedidos-fill" style="width: {% widthratio pedidos_entregado total_pedidos|default:1 100 %}%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card" data-animate="fade-in" style="animation-delay: 0.3s">
                    <div class="stat-icon ingresos">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Ingresos Totales</h3>
                        <p class="stat-number">${{ ingresos_totales|floatformat:2 }}</p>
                        <p class="stat-label">pagos confirmados</p>
                        <div class="progress-bar">
                            <div class="progress-fill ingresos-fill" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos por Categor칤a -->
            <div class="stats-section" data-animate="slide-up">
                <h2><i class="fas fa-layer-group"></i> Productos por Categor칤a</h2>
                <div class="chart-container">
                    <canvas id="categoriasChart"></canvas>
                </div>
                <div class="productos-categoria-grid">
                    <div class="categoria-item" data-animate="zoom-in" style="animation-delay: 0.1s">
                        <div class="categoria-icon"><i class="fas fa-table"></i></div>
                        <p class="categoria-nombre">Mesas</p>
                        <p class="categoria-cantidad" data-count="{{ total_mesas }}">0</p>
                        <p class="stat-label">{{ inventario_mesas }} unidades</p>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: {% widthratio inventario_mesas total_inventario|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="categoria-item" data-animate="zoom-in" style="animation-delay: 0.2s">
                        <div class="categoria-icon"><i class="fas fa-chair"></i></div>
                        <p class="categoria-nombre">Sillas</p>
                        <p class="categoria-cantidad" data-count="{{ total_sillas }}">0</p>
                        <p class="stat-label">{{ inventario_sillas }} unidades</p>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: {% widthratio inventario_sillas total_inventario|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="categoria-item" data-animate="zoom-in" style="animation-delay: 0.3s">
                        <div class="categoria-icon"><i class="fas fa-door-closed"></i></div>
                        <p class="categoria-nombre">Armarios</p>
                        <p class="categoria-cantidad" data-count="{{ total_armarios }}">0</p>
                        <p class="stat-label">{{ inventario_armarios }} unidades</p>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: {% widthratio inventario_armarios total_inventario|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="categoria-item" data-animate="zoom-in" style="animation-delay: 0.4s">
                        <div class="categoria-icon"><i class="fas fa-archive"></i></div>
                        <p class="categoria-nombre">Cajoneras</p>
                        <p class="categoria-cantidad" data-count="{{ total_cajoneras }}">0</p>
                        <p class="stat-label">{{ inventario_cajoneras }} unidades</p>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: {% widthratio inventario_cajoneras total_inventario|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="categoria-item" data-animate="zoom-in" style="animation-delay: 0.5s">
                        <div class="categoria-icon"><i class="fas fa-desk"></i></div>
                        <p class="categoria-nombre">Escritorios</p>
                        <p class="categoria-cantidad" data-count="{{ total_escritorios }}">0</p>
                        <p class="stat-label">{{ inventario_escritorios }} unidades</p>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: {% widthratio inventario_escritorios total_inventario|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="categoria-item" data-animate="zoom-in" style="animation-delay: 0.6s">
                        <div class="categoria-icon"><i class="fas fa-utensils"></i></div>
                        <p class="categoria-nombre">Utensilios</p>
                        <p class="categoria-cantidad" data-count="{{ total_utensilios }}">0</p>
                        <p class="stat-label">{{ inventario_utensilios }} unidades</p>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: {% widthratio inventario_utensilios total_inventario|default:1 100 %}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado de Pedidos -->
            <div class="stats-section" data-animate="slide-up" style="animation-delay: 0.2s">
                <h2><i class="fas fa-truck"></i> Estado de Pedidos</h2>
                <div class="chart-container-small">
                    <canvas id="pedidosChart"></canvas>
                </div>
                <div class="estados-grid">
                    <div class="estado-item procesando" data-animate="bounce-in">
                        <i class="fas fa-spinner fa-pulse"></i>
                        <p class="estado-numero" data-count="{{ pedidos_procesando }}">0</p>
                        <p class="estado-label">Procesando</p>
                        <div class="estado-bar">
                            <div class="estado-bar-fill procesando-fill" style="width: {% widthratio pedidos_procesando total_pedidos|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="estado-item enviado" data-animate="bounce-in" style="animation-delay: 0.1s">
                        <i class="fas fa-truck-loading"></i>
                        <p class="estado-numero" data-count="{{ pedidos_enviado }}">0</p>
                        <p class="estado-label">Enviado</p>
                        <div class="estado-bar">
                            <div class="estado-bar-fill enviado-fill" style="width: {% widthratio pedidos_enviado total_pedidos|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="estado-item entregado" data-animate="bounce-in" style="animation-delay: 0.2s">
                        <i class="fas fa-check-circle"></i>
                        <p class="estado-numero" data-count="{{ pedidos_entregado }}">0</p>
                        <p class="estado-label">Entregado</p>
                        <div class="estado-bar">
                            <div class="estado-bar-fill entregado-fill" style="width: {% widthratio pedidos_entregado total_pedidos|default:1 100 %}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado de Pagos -->
            <div class="stats-section" data-animate="slide-up" style="animation-delay: 0.3s">
                <h2><i class="fas fa-money-bill-wave"></i> Estado de Pagos</h2>
                <div class="chart-container-small">
                    <canvas id="pagosChart"></canvas>
                </div>
                <div class="estados-grid">
                    <div class="estado-item pendiente" data-animate="bounce-in">
                        <i class="fas fa-clock"></i>
                        <p class="estado-numero" data-count="{{ pagos_pendientes }}">0</p>
                        <p class="estado-label">Pendiente</p>
                        <div class="estado-bar">
                            <div class="estado-bar-fill pendiente-fill" style="width: {% widthratio pagos_pendientes pagos_pendientes|add:pagos_confirmados|add:pagos_rechazados|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="estado-item confirmado" data-animate="bounce-in" style="animation-delay: 0.1s">
                        <i class="fas fa-check-double"></i>
                        <p class="estado-numero" data-count="{{ pagos_confirmados }}">0</p>
                        <p class="estado-label">Confirmado</p>
                        <div class="estado-bar">
                            <div class="estado-bar-fill confirmado-fill" style="width: {% widthratio pagos_confirmados pagos_pendientes|add:pagos_confirmados|add:pagos_rechazados|default:1 100 %}%"></div>
                        </div>
                    </div>
                    <div class="estado-item rechazado" data-animate="bounce-in" style="animation-delay: 0.2s">
                        <i class="fas fa-times-circle"></i>
                        <p class="estado-numero" data-count="{{ pagos_rechazados }}">0</p>
                        <p class="estado-label">Rechazado</p>
                        <div class="estado-bar">
                            <div class="estado-bar-fill rechazado-fill" style="width: {% widthratio pagos_rechazados pagos_pendientes|add:pagos_confirmados|add:pagos_rechazados|default:1 100 %}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

{% load static %}
<!-- Incluir estilos para el bot칩n flotante de notificaciones empresa -->
<link rel="stylesheet" href="{% static 'core/css/floating.css' %}">
<link rel="stylesheet" href="{% static 'core/css/notificaciones.css' %}">

<!-- Bot칩n flotante de notificaciones para empresa -->
<a id="floating-notif-btn-empresa" class="floating-btn floating-notif" style="display: flex;" title="Notificaciones" onclick="event.preventDefault(); abrirNotificaciones();">
    <span class="fb-icon">游댒</span>
    <span id="floating-notif-badge-empresa" class="fb-badge" style="display:none">0</span>
</a>

{% include 'core/modal_notificaciones.html' %}

<script>
// Animaci칩n de contador
function animateCounter(element) {
    const target = parseInt(element.getAttribute('data-count'));
    const duration = 2000;
    const increment = target / (duration / 16);
    let current = 0;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            element.textContent = target;
            clearInterval(timer);
        } else {
            element.textContent = Math.floor(current);
        }
    }, 16);
}

// Inicializar gr치ficos
function inicializarGraficos() {
    // Gr치fico de categor칤as
    const ctxCategorias = document.getElementById('categoriasChart').getContext('2d');
    new Chart(ctxCategorias, {
        type: 'doughnut',
        data: {
            labels: ['Mesas', 'Sillas', 'Armarios', 'Cajoneras', 'Escritorios', 'Utensilios'],
            datasets: [{
                data: [
                    {{ total_mesas|default:0 }},
                    {{ total_sillas|default:0 }},
                    {{ total_armarios|default:0 }},
                    {{ total_cajoneras|default:0 }},
                    {{ total_escritorios|default:0 }},
                    {{ total_utensilios|default:0 }}
                ],
                backgroundColor: [
                    '#A0662F',
                    '#7A3E0E',
                    '#6B4E3D',
                    '#C9A882',
                    '#8B5A3C',
                    '#D4A574'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' productos';
                        }
                    }
                }
            }
        }
    });

    // Gr치fico de pedidos
    const ctxPedidos = document.getElementById('pedidosChart').getContext('2d');
    new Chart(ctxPedidos, {
        type: 'bar',
        data: {
            labels: ['Procesando', 'Enviado', 'Entregado'],
            datasets: [{
                label: 'Pedidos',
                data: [
                    {{ pedidos_procesando|default:0 }},
                    {{ pedidos_enviado|default:0 }},
                    {{ pedidos_entregado|default:0 }}
                ],
                backgroundColor: [
                    '#FFA500',
                    '#4169E1',
                    '#32CD32'
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

    // Gr치fico de pagos
    const ctxPagos = document.getElementById('pagosChart').getContext('2d');
    new Chart(ctxPagos, {
        type: 'pie',
        data: {
            labels: ['Pendiente', 'Confirmado', 'Rechazado'],
            datasets: [{
                data: [
                    {{ pagos_pendientes|default:0 }},
                    {{ pagos_confirmados|default:0 }},
                    {{ pagos_rechazados|default:0 }}
                ],
                backgroundColor: [
                    '#FFA500',
                    '#32CD32',
                    '#DC3545'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                }
            }
        }
    });
}

// Funci칩n para actualizar estad칤sticas
function actualizarEstadisticas() {
    const btn = document.querySelector('.btn-refresh i');
    btn.classList.add('fa-spin');
    
    setTimeout(() => {
        location.reload();
    }, 500);
}

// Inicializar cuando cargue la p치gina
document.addEventListener('DOMContentLoaded', function() {
    // Animar contadores
    document.querySelectorAll('[data-count]').forEach(animateCounter);
    
    // Inicializar gr치ficos
    inicializarGraficos();
    
    // Observer para animaciones
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
            }
        });
    }, { threshold: 0.1 });
    
    document.querySelectorAll('[data-animate]').forEach(el => observer.observe(el));
});

// Actualizar notificaciones cada 30 segundos para empresa
function actualizarNotificacionesEmpresa() {
    fetch('/api/conversaciones/')
        .then(response => response.json())
        .then(data => {
            const btn = document.getElementById('floating-notif-btn-empresa');
            const badge = document.getElementById('floating-notif-badge-empresa');
            
            if (data.success && data.conversaciones) {
                const tieneNoLeidos = data.conversaciones.some(c => c.mensajes_no_leidos > 0);
                
                if (tieneNoLeidos) {
                    btn.style.display = 'flex';
                    badge.style.display = 'inline-block';
                } else if (data.conversaciones.length > 0) {
                    btn.style.display = 'flex';
                    badge.style.display = 'none';
                } else {
                    btn.style.display = 'none';
                }
            }
        })
        .catch(err => console.warn('Error al verificar notificaciones empresa:', err));
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    setInterval(actualizarNotificacionesEmpresa, 30000);
});
</script>

</body>
</html>
