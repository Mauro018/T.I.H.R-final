<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n de Pagos | Dashboard Empresa</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'Empresas/css/styles3.css' %}">
    <link rel="stylesheet" href="{% static 'Empresas/css/pagos.css' %}">

</head>
<body>
    <div class="dashboard-container">
        <aside>
            <h2>Dashboard de Empresa</h2>
            <nav>
                <ul>
                    <li><a href="{% url 'dashboardEmpresa' %}">Inicio</a></li>
                    <li><a href="{% url 'usuarios' %}">Gesti贸n de usuarios</a></li>
                    <li><a href="{% url 'GestiProductos' %}">Gesti贸n de productos</a></li>
                    <li><a href="{% url 'inventario' %}">Inventario</a></li>
                    <li><a href="{% url 'empresa_ideas' %}">Gesti贸n de ideas</a></li>
                    <li><a href="{% url 'empresa_comentarios' %}">Gesti贸n de comentarios</a></li>
                    <li><a href="{% url 'gestion_pagos' %}">Gesti贸n de pagos</a></li>
                    <li><a href="{% url 'gestion_pedidos' %}">Gesti贸n de pedidos</a></li>
                    <li><a href="{% url 'estadisticas' %}">Estad铆sticas</a></li>
                </ul>
            </nav>
            <a href="{% url 'logout' %}" class="logout-button">Cerrar sesi贸n</a>
        </aside>

        <main>
            <header>
                <h1>Gesti贸n de Pagos</h1>
            </header>

            {% if clientes_con_pagos %}
                <div class="tabla-clientes">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Cantidad de Pagos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes_con_pagos %}
                            <tr>
                                <td>{{ cliente.usernameCliente }}</td>
                                <td>{{ cliente.email }}</td>
                                <td><strong>{{ cliente.cantidad_pagos }}</strong></td>
                                <td>
                                    <button class="btn-ver-pagos" onclick="verPagosCliente({{ cliente.id }}, '{{ cliente.usernameCliente }}')">
                                        Ver Pagos
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-datos">
                    No hay pagos registrados a煤n.
                </div>
            {% endif %}
        </main>
    </div>

    <!-- Modal Ver Pagos del Cliente -->
    <div id="modalPagosCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pagos de <span id="nombreClientePagos"></span></h2>
                <button class="close" onclick="cerrarModalPagos()">&times;</button>
            </div>
            <div class="modal-body" id="listaPagos">
                <!-- Se cargar谩 din谩micamente -->
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles del Pago -->
    <div id="modalDetallesPago" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalles del Pago #<span id="numeroPago"></span></h2>
                <button class="close" onclick="cerrarModalDetallesPago()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <button class="modal-tab active" onclick="cambiarTabPago(event, 'tabProductosPago')">Detalles de Compra</button>
                    <button class="modal-tab" onclick="cambiarTabPago(event, 'tabComprobantePago')">Comprobante de Pago</button>
                </div>

                <div id="tabProductosPago" class="modal-tab-content active">
                    <h3>Productos del Pago</h3>
                    <div id="productosListaPago"></div>
                </div>

                <div id="tabComprobantePago" class="modal-tab-content">
                    <h3>Comprobante de Pago</h3>
                    <img id="imgComprobantePago" class="comprobante-img" src="" alt="Comprobante">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chat (se mantiene igual) -->
    <div id="modalChat" class="modal chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat con Cliente</h2>
                <button class="close" onclick="cerrarModal('modalChat')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chat-container-pago">
                    <div id="chatMensajesLocal" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <textarea id="chatMensajeLocal" placeholder="Escribe tu mensaje..." rows="2"></textarea>
                        <label for="chatImagenLocal" class="file-input-label" title="Adjuntar imagen">
                            
                            <input type="file" id="chatImagenLocal" accept="image/*" style="display: none;">
                        </label>
                        <div id="imagenPreviewLocal"></div>
                        <button onclick="enviarMensajeLocal()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ver pagos del cliente
        function verPagosCliente(clienteId, nombreCliente) {
            document.getElementById('nombreClientePagos').textContent = nombreCliente;
            
            fetch(`/obtener-pagos-cliente/${clienteId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarPagos(data.pagos);
                    document.getElementById('modalPagosCliente').style.display = 'block';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los pagos');
            });
        }

        // Mostrar lista de pagos
        function mostrarPagos(pagos) {
            const lista = document.getElementById('listaPagos');
            
            if (pagos.length === 0) {
                lista.innerHTML = '<div class="no-datos">Este cliente no tiene pagos a煤n.</div>';
                return;
            }
            
            lista.innerHTML = pagos.map(pago => {
                const estadoClass = 'badge-estado badge-' + pago.estado;
                const estadoTexto = pago.estado === 'pendiente' ? 'Pendiente' : pago.estado === 'confirmado' ? 'Confirmado' : 'Rechazado';
                
                let botones = '';
                if (pago.estado === 'pendiente') {
                    botones = `
                        <button class="btn-small btn-confirmar" onclick="confirmarPagoDesdeLista(${pago.id})">Confirmar</button>
                        <button class="btn-small btn-rechazar" onclick="rechazarPagoDesdeLista(${pago.id})">Rechazar</button>
                    `;
                } else if (pago.estado === 'rechazado') {
                    botones = `<button class="btn-small btn-chat" onclick="abrirChatPagoDesdeGestion(${pago.id})">Contactar</button>`;
                }
                
                return `
                    <div class="pedido-card">
                        <div class="pedido-header">
                            <h3>Pago #${pago.id}</h3>
                            <span class="${estadoClass}">${estadoTexto}</span>
                        </div>
                        <div class="pedido-info">
                            <div class="info-item">
                                <span class="info-label">Fecha</span>
                                <span class="info-value">${pago.fecha_creacion}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Total</span>
                                <span class="info-value">$${pago.monto_total}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Productos</span>
                                <span class="info-value">${pago.cantidad_productos} items</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn-small btn-ver-detalles-pedido" onclick='verDetallesPagoModal(${JSON.stringify(pago)})'>Ver Detalles</button>
                            ${botones}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Ver detalles del pago en modal
        function verDetallesPagoModal(pago) {
            document.getElementById('numeroPago').textContent = pago.id;
            document.getElementById('imgComprobantePago').src = pago.comprobante_url;
            
            // Mostrar productos
            const productosHtml = pago.productos.map(p => `
                <div class="producto-detalle">
                    ${p.imagen ? `<img src="${p.imagen}" alt="${p.nombre}" class="producto-imagen">` : ''}
                    <div class="producto-info">
                        <span><strong>${p.nombre}</strong></span>
                        <span>Cantidad: ${p.cantidad}</span>
                        <span>Precio: $${p.precio}</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('productosListaPago').innerHTML = productosHtml;
            document.getElementById('modalDetallesPago').style.display = 'block';
        }

        // Cambiar tab en modal de detalles
        function cambiarTabPago(event, tabId) {
            const tabs = document.querySelectorAll('#modalDetallesPago .modal-tab');
            const contents = document.querySelectorAll('#modalDetallesPago .modal-tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Funciones de confirmar/rechazar desde lista
        function confirmarPagoDesdeLista(pagoId) {
            if (!confirm('驴Confirmar este pago? Se descontar谩 el inventario.')) return;
            
            const formData = new FormData();
            formData.append('notas', ''); // Notas opcionales al confirmar
            
            fetch(`/confirmar-pago/${pagoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.mensaje || 'Pago confirmado exitosamente');
                    // El pago fue confirmado y el pedido creado - recargar para mostrar cambios
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al confirmar pago');
            });
        }
        
        // Funci贸n para obtener cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function rechazarPagoDesdeLista(pagoId) {
            const motivo = prompt('Indica el motivo del rechazo:');
            if (!motivo) return;
            
            fetch(`/rechazar-pago/${pagoId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `notas=${encodeURIComponent(motivo)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Pago rechazado');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al rechazar pago');
            });
        }

        // Cerrar modales
        function cerrarModalPagos() {
            document.getElementById('modalPagosCliente').style.display = 'none';
        }

        function cerrarModalDetallesPago() {
            document.getElementById('modalDetallesPago').style.display = 'none';
        }

        // Chat functions - Redirigir al modal de notificaciones
        function abrirChatPagoDesdeGestion(pagoId) {
            // Verificar si existe la funci贸n del modal de notificaciones
            if (typeof abrirNotificaciones === 'function' && typeof abrirChatPago === 'function') {
                // Abrir el modal de notificaciones
                abrirNotificaciones();
                // Esperar un momento para que se cargue y luego abrir el chat espec铆fico
                setTimeout(() => {
                    abrirChatPago(pagoId);
                }, 500);
            } else {
                alert('El sistema de notificaciones no est谩 disponible. Por favor, recarga la p谩gina.');
            }
        }

        function cargarMensajes(pagoId) {
            fetch(`/obtener-mensajes-pago/${pagoId}/`)
            .then(response => response.json())
            .then(data => {
                const chatMessages = document.getElementById('chatMensajesLocal');
                chatMessages.innerHTML = '';
                
                data.mensajes.forEach(mensaje => {
                    const div = document.createElement('div');
                    div.className = `chat-message ${mensaje.remitente_tipo}`;
                    
                    let html = `
                        <div class="chat-message-header">
                            <strong>${mensaje.remitente_nombre}</strong> - ${mensaje.fecha_envio}
                        </div>
                        <div class="chat-message-text">${mensaje.mensaje}</div>
                    `;
                    
                    if (mensaje.imagen) {
                        html += `<img src="${mensaje.imagen}" class="chat-message-img" onclick="window.open('${mensaje.imagen}', '_blank')">`;
                    }
                    
                    div.innerHTML = html;
                    chatMessages.appendChild(div);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => console.error('Error:', error));
        }

        // Enviar mensaje del chat
        function enviarMensajeLocal() {
            const mensaje = document.getElementById('chatMensajeLocal').value.trim();
            const imagenInput = document.getElementById('chatImagenLocal');
            
            if (!mensaje && !imagenInput.files.length) {
                alert('Debes escribir un mensaje o adjuntar una imagen');
                return;
            }

            const formData = new FormData();
            formData.append('mensaje', mensaje);
            if (imagenInput.files.length) {
                formData.append('imagen', imagenInput.files[0]);
            }

            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(`/enviar-mensaje-pago/${currentPagoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('chatMensajeLocal').value = '';
                    imagenInput.value = '';
                    document.getElementById('imagenPreviewLocal').innerHTML = '';
                    cargarMensajes(currentPagoId);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurri贸 un error al enviar el mensaje');
            });
        }

        // Preview de imagen
        document.getElementById('chatImagenLocal').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagenPreviewLocal').innerHTML = `
                        <img src="${e.target.result}" style="max-width: 150px; border-radius: 4px;">
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        // Cerrar modales
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Recargar mensajes cada 5 segundos si el chat est谩 abierto
        setInterval(() => {
            if (document.getElementById('modalChat').style.display === 'block' && currentPagoId) {
                cargarMensajes(currentPagoId);
            }
        }, 5000);
    </script>

    <!-- Incluir modal de notificaciones -->
    {% include 'core/modal_notificaciones.html' %}

{% load static %}
<!-- Incluir estilos para el bot贸n flotante de notificaciones empresa -->
<link rel="stylesheet" href="{% static 'core/css/floating.css' %}">
<link rel="stylesheet" href="{% static 'core/css/notificaciones.css' %}">

<!-- Bot贸n flotante de notificaciones para empresa -->
<a id="floating-notif-btn-empresa" class="floating-btn floating-notif" style="display: flex;" title="Notificaciones" onclick="event.preventDefault(); abrirNotificaciones();">
    <span class="fb-icon"></span>
    <span id="floating-notif-badge-empresa" class="fb-badge" style="display:none">0</span>
</a>

<script>
// Actualizar notificaciones cada 30 segundos para empresa
function actualizarNotificacionesEmpresa() {
    fetch('/api/conversaciones/')
        .then(response => response.json())
        .then(data => {
            const btn = document.getElementById('floating-notif-btn-empresa');
            const badge = document.getElementById('floating-notif-badge-empresa');
            
            if (data.success && data.conversaciones) {
                const tieneNoLeidos = data.conversaciones.some(c => c.mensajes_no_leidos > 0);
                
                if (tieneNoLeidos) {
                    btn.style.display = 'flex';
                    badge.style.display = 'inline-block';
                } else if (data.conversaciones.length > 0) {
                    btn.style.display = 'flex';
                    badge.style.display = 'none';
                } else {
                    btn.style.display = 'none';
                }
            }
        })
        .catch(err => console.warn('Error al verificar notificaciones empresa:', err));
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    actualizarNotificacionesEmpresa();
    setInterval(actualizarNotificacionesEmpresa, 30000);
});
</script>

</body>
</html>
