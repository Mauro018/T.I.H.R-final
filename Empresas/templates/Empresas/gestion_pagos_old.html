<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pagos | Dashboard Empresa</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'Empresas/css/styles3.css' %}">
</head>
<body>
    <div class="dashboard-container">
        <aside>
            <h2>Dashboard de Empresa</h2>
            <nav>
                <ul>
                    <li><a href="{% url 'dashboardEmpresa' %}">Inicio</a></li>
                    <li><a href="{% url 'usuarios' %}">Gestión de usuarios</a></li>
                    <li><a href="{% url 'GestiProductos' %}">Gestión de productos</a></li>
                    <li><a href="{% url 'inventario' %}">Inventario</a></li>
                    <li><a href="{% url 'empresa_ideas' %}">Gestión de ideas</a></li>
                    <li><a href="{% url 'empresa_comentarios' %}">Gestión de comentarios</a></li>
                    <li><a href="{% url 'gestion_pagos' %}">Gestión de pagos</a></li>
                    <li><a href="{% url 'gestion_pedidos' %}">Gestión de pedidos</a></li>
                    <li><a href="{% url 'estadisticas' %}">Estadísticas</a></li>
                </ul>
            </nav>
            <a href="{% url 'logout' %}" class="logout-button">Cerrar sesión</a>
        </aside>

        <main>
            <header>
                <h1>Gestión de Pagos</h1>
            </header>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Pestañas para filtrar pagos -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="pendientes">
                    Pendientes <span class="badge">{{ pagos_pendientes.count }}</span>
                </button>
                <button class="tab-btn" data-tab="confirmados">
                    Confirmados <span class="badge" style="background: #28a745;">{{ pagos_confirmados.count }}</span>
                </button>
                <button class="tab-btn" data-tab="rechazados">
                    Rechazados <span class="badge">{{ pagos_rechazados.count }}</span>
                </button>
            </div>

            <!-- Contenido de Pagos Pendientes -->
            <div class="tab-content active" id="pendientes">
                <h2>Pagos Pendientes de Confirmación</h2>
                {% if pagos_pendientes %}
                    <div class="pagos-grid">
                        {% for pago in pagos_pendientes %}
                            <div class="pago-card">
                                <div class="pago-header">
                                    <div class="pago-info">
                                        <h3>{{ pago.cliente.usernameCliente }}</h3>
                                        <span class="pago-fecha">{{ pago.fecha_creacion|date:"d/m/Y" }}</span>
                                        <span class="pago-fecha">Email: {{ pago.cliente.email }}</span>
                                    </div>
                                    <div class="pago-monto">
                                        ${{ pago.monto_total }}
                                    </div>
                                </div>

                                <div class="pago-metodo">
                                    <strong>Método de pago:</strong> {{ pago.get_metodo_pago_display }}
                                </div>

                                <div class="pago-productos">
                                    <strong>Productos:</strong>
                                    <div class="productos-lista">
                                        {% for producto in pago.productos_parseados %}
                                            <div class="producto-item">
                                                {{ producto.nombre }} x{{ producto.cantidad }} - ${{ producto.precio }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="pago-comprobante">
                                    <strong>Comprobante de pago:</strong>
                                    <img src="{{ pago.comprobante.url }}" alt="Comprobante" class="comprobante-thumbnail" onclick="window.open('{{ pago.comprobante.url }}', '_blank')">
                                </div>

                                <div class="pago-actions">
                                    <button class="btn-confirmar" onclick="confirmarPago({{ pago.id }})">
                                        ✓ Confirmar Pago
                                    </button>
                                    <button class="btn-rechazar" onclick="rechazarPago({{ pago.id }})">
                                        ✗ Rechazar
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-pagos">
                        No hay pagos pendientes de confirmación.
                    </div>
                {% endif %}
            </div>

            <!-- Contenido de Pagos Confirmados -->
            <div class="tab-content" id="confirmados">
                <h2>Pagos Confirmados</h2>
                {% if pagos_confirmados %}
                    <div class="pagos-grid">
                        {% for pago in pagos_confirmados %}
                            <div class="pago-card pago-confirmado">
                                <div class="pago-header">
                                    <div class="pago-info">
                                        <h3>{{ pago.cliente.usernameCliente }}</h3>
                                        <span class="pago-fecha">Realizado: {{ pago.fecha_creacion|date:"d/m/Y" }}</span>
                                        <span class="pago-fecha">Confirmado: {{ pago.fecha_confirmacion|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="pago-monto">
                                        ${{ pago.monto_total }}
                                    </div>
                                </div>

                                <div class="pago-metodo">
                                    <strong>Método de pago:</strong> {{ pago.get_metodo_pago_display }}
                                </div>

                                <div class="pago-productos">
                                    <strong>Productos:</strong>
                                    <div class="productos-lista">
                                        {% for producto in pago.productos_parseados %}
                                            <div class="producto-item">
                                                {{ producto.nombre }} x{{ producto.cantidad }} - ${{ producto.precio }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="pago-comprobante">
                                    <strong>Comprobante de pago:</strong>
                                    <img src="{{ pago.comprobante.url }}" alt="Comprobante" class="comprobante-thumbnail" onclick="window.open('{{ pago.comprobante.url }}', '_blank')">
                                </div>

                                {% if pago.notas_empresa %}
                                    <div class="pago-notas">
                                        <strong>Notas:</strong>
                                        <p>{{ pago.notas_empresa }}</p>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-pagos">
                        No hay pagos confirmados todavía.
                    </div>
                {% endif %}
            </div>

            <!-- Contenido de Pagos Rechazados -->
            <div class="tab-content" id="rechazados">
                <h2>Pagos Rechazados</h2>
                {% if pagos_rechazados %}
                    <div class="pagos-grid">
                        {% for pago in pagos_rechazados %}
                            <div class="pago-card pago-rechazado">
                                <div class="pago-header">
                                    <div class="pago-info">
                                        <h3>{{ pago.cliente.usernameCliente }}</h3>
                                        <span class="pago-fecha">{{ pago.fecha_creacion|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="pago-monto">
                                        ${{ pago.monto_total }}
                                    </div>
                                </div>

                                <div class="pago-metodo">
                                    <strong>Método de pago:</strong> {{ pago.get_metodo_pago_display }}
                                </div>

                                <div class="pago-productos">
                                    <strong>Productos:</strong>
                                    <div class="productos-lista">
                                        {% for producto in pago.productos_parseados %}
                                            <div class="producto-item">
                                                {{ producto.nombre }} x{{ producto.cantidad }} - ${{ producto.precio }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="pago-comprobante">
                                    <strong>Comprobante de pago:</strong>
                                    <img src="{{ pago.comprobante.url }}" alt="Comprobante" class="comprobante-thumbnail" onclick="window.open('{{ pago.comprobante.url }}', '_blank')">
                                </div>

                                {% if pago.notas_empresa %}
                                    <div class="pago-notas" style="background: #f8d7da; border-left-color: #dc3545;">
                                        <strong>Motivo del rechazo:</strong>
                                        <p>{{ pago.notas_empresa }}</p>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-pagos">
                        No hay pagos rechazados.
                    </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Modal para notas -->
    <div id="notasModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Agregar Notas</h2>
            <textarea id="notasTextarea" placeholder="Escribe tus notas aquí..."></textarea>
            <div class="modal-actions">
                <button class="btn-modal-confirmar" id="modalConfirmarBtn">Confirmar</button>
                <button class="btn-modal-cancelar" id="modalCancelarBtn">Cancelar</button>
            </div>
        </div>
    </div>

    {% csrf_token %}

    <script>
        // Manejo de pestañas
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');

                // Remover active de todos
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Activar el seleccionado
                button.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Variables para el modal
        const modal = document.getElementById('notasModal');
        const closeModal = document.querySelector('.close');
        const modalTitle = document.getElementById('modalTitle');
        const notasTextarea = document.getElementById('notasTextarea');
        const modalConfirmarBtn = document.getElementById('modalConfirmarBtn');
        const modalCancelarBtn = document.getElementById('modalCancelarBtn');
        let currentAction = null;
        let currentPagoId = null;

        // Funciones para abrir/cerrar modal
        function openModal(title, pagoId, action) {
            modalTitle.textContent = title;
            notasTextarea.value = '';
            currentPagoId = pagoId;
            currentAction = action;
            modal.style.display = 'block';
            
            if (action === 'rechazar') {
                notasTextarea.placeholder = 'Motivo del rechazo (obligatorio)...';
            } else {
                notasTextarea.placeholder = 'Notas adicionales (opcional)...';
            }
        }

        function closeModalFunc() {
            modal.style.display = 'none';
            notasTextarea.value = '';
            currentPagoId = null;
            currentAction = null;
        }

        closeModal.onclick = closeModalFunc;
        modalCancelarBtn.onclick = closeModalFunc;

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModalFunc();
            }
        }

        // Funciones de confirmación y rechazo
        function confirmarPago(pagoId) {
            openModal('Confirmar Pago', pagoId, 'confirmar');
        }

        function rechazarPago(pagoId) {
            openModal('Rechazar Pago', pagoId, 'rechazar');
        }

        // Confirmar acción del modal
        modalConfirmarBtn.addEventListener('click', function() {
            const notas = notasTextarea.value.trim();
            
            if (currentAction === 'rechazar' && !notas) {
                alert('Debes proporcionar un motivo para rechazar el pago');
                return;
            }

            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const url = currentAction === 'confirmar' 
                ? `/confirmar-pago/${currentPagoId}/`
                : `/rechazar-pago/${currentPagoId}/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `notas=${encodeURIComponent(notas)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.mensaje);
                    // Si hay URL de redirección (para crear pedido), notificar al cliente
                    if (data.redirect_url && currentAction === 'confirmar') {
                        alert('El cliente será notificado para completar sus datos de envío.');
                    }
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error al procesar la solicitud');
            });

            closeModalFunc();
        });
    </script>
</body>
</html>
