<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %} {% endblock %} | Tu Idea Hecha Realidad</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'Productos/css/styles1.css' %}">
</head>
<body>
 
<!-- BARRA LATERAL (MEN + FILTROS) -->
<div class="sidebar">
    <div class="sidebar-user-info">
        <a href="{% url 'perfilUsuario' %}" class="user-avatar-link">
            {% if usuario.foto_perfil %}
                <img src="{{ usuario.foto_perfil.url }}" alt="Foto de perfil" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F; object-fit: cover;">
            {% else %}
                <img src="{% static 'core/img/Perfil.png' %}" alt="Logo" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F;">
            {% endif %}
        </a>
        <span class="username-display">{{ usuario.usernameCliente }}</span>
    </div>
  <ul>
    <li><a href="{% url 'productos' %}">Ofertas</a></li>
    <li><a href="{% url 'idea' %}">Crear Idea</a></li>
    <li><a href="{% url 'mis_pedidos' %}">Mis Pedidos</a></li>
    <li><a href="{% url 'contact' %}">Cont谩ctenos</a></li>
    <li><a href="{% url 'comentarios' %}">Comentarios</a></li>
    <li><a href="{% url 'logout' %}" class="logout-button">Cerrar Sesi贸n</a></li>
  </ul>

  <!-- FILTROS -->
  <div class="filtros">
    <h2 for="categoria" class="h2-side">Categor铆a:</h2>
    <select id="categoria">
        <option value="">Elegir Categoria</option> 
        <option value="carpinteria">Armarios</option>
        <option value="marroquineria">Escritorios</option>
        <option value="vidrieria">Sillas</option>
        <option value="metaleria">Cajoneras</option>
        <option value="ceramica">Mesas</option>
        <option value="tapiceria">Utensilios</option>
    </select>

    <button onclick="aplicarFiltros()">Aplicar filtros</button>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="main-content-wrapper">
  <header>
    <h1 class="div" style="text-align: center;">
      <img src="{% static 'core/img/Gemini_Generated_Image_tzay6utzay6utzay.jfif' %}" alt="Logo" width="75" height="75">
      Tu Idea Hecha Realidad
    </h1>
  </header>

<section>
    <div>
        <h2>CARPINTERIA</h2>
        <section class="seccion-at">
            <div>
                <div>
                    <div>
                        <div>
                            <div>
                                <h3>Cajoneras:</h3>
                            </div>
                        </div>
                    </div>
                    <div class="contenedor-articulos" id="contenedorArticulos">
                        {% for cajonera in cajoneras %}
                        <div class="articulo">
                            {% if cajonera.imagen4 %}
                            <img src="{{ cajonera.imagen4.url }}" alt="{{ cajonera.nombre4 }}">
                            {% else %}
                            <img src="{% static 'Productos/img/Cajonera1.webp' %}" alt="{{ cajonera.nombre4 }}">
                            {% endif %}
                            <div class="contenido-articulo">
                                <h3>{{ cajonera.nombre4 }}</h3>
                                <p>{{ cajonera.descripcion4 }}</p>
                                <p><strong>Precio: ${{ cajonera.precio4 }}</strong></p>
                                <button class="btn-ver-detalles" onclick="mostrarDetalles('cajonera', {{ cajonera.id }}, '{{ cajonera.nombre4 }}', '{{ cajonera.descripcion4 }}', {{ cajonera.precio4 }}, '{% if cajonera.imagen4 %}{{ cajonera.imagen4.url }}{% else %}{% static 'Productos/img/Cajonera1.webp' %}{% endif %}')">Ver Detalles</button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="articulo">
                            <img src="{% static 'Productos/img/Cajonera1.webp' %}" alt="Imagen del Producto 1">
                            <div class="contenido-articulo">
                                <h3>No hay productos disponibles</h3>
                                <p>Pr贸ximamente nuevos productos</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>
    </div>
</section>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title"> Cont谩ctenos</h3>
                <div class="footer-info">
                    <i></i>
                    <span>+57 300 123 4567</span>
                </div>
                <div class="footer-info">
                    <i>锔</i>
                    <span>info@gangasca-tirr.com</span>
                </div>
            </div>
            
            <div class="footer-section">
                <h3 class="footer-title"> Direcci贸n</h3>
                <div class="footer-info">
                    <i></i>
                    <span>Carrera 45 P. 26-85<br>RoyalA, Colombia</span>
                </div>
            </div>
            
            <div class="footer-section">
                <h3 class="footer-title"> S铆guenos</h3>
                <div class="footer-social">
                    <div class="social-container">
                        <a href="https://www.instagram.com/tu_idea_hecha_realidad?igsh=Y3ByM2lyZGcwNHVy" class="social-icon" aria-label="Instagram">
                            <span></span>
                        </a>
                        <div class="social-username">@Gangazos Thir</div>
                    </div>
                    <div class="social-container">
                        <a href="https://www.facebook.com/share/1ACEVZbZHV/" class="social-icon" aria-label="Facebook">
                            <span></span>
                        </a>
                        <div class="social-username">/gangazoz_thir</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>漏 2025 Tu Idea Herba Realidad - Todos los derechos reservados</p>
        </div>
    </footer>
</div>

<!-- Modal de Detalles del Producto -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2 id="modalProductName">Producto</h2>
        </div>
        <div class="modal-body">
            <img id="modalImage" src="" alt="Producto" class="modal-product-image">
            <div class="modal-product-info">
                <p id="modalProductDescription">Descripci贸n del producto</p>
                <p class="precio-destacado">Precio: $<span id="modalProductPrice">0</span></p>
                <p id="disponibilidadText" style="font-weight: bold; margin-top: 10px;"></p>
            </div>
            <div class="quantity-selector">
                <button onclick="cambiarCantidad(-1)">-</button>
                <input type="number" id="quantity" value="1" min="1" readonly>
                <button onclick="cambiarCantidad(1)">+</button>
            </div>
            <p class="precio-destacado">Total: $<span id="totalPrice">0</span></p>
        </div>
        <div class="modal-footer">
            <button class="btn-comprar" onclick="agregarAlCarrito()">Comprar</button>
        </div>
    </div>
</div>

<script>
    let currentProduct = {};
    async function mostrarDetalles(tipo, id, nombre, descripcion, precio, imagen) {
        console.log('Mostrando detalles:', tipo, id, nombre);
        currentProduct = {tipo: tipo, id: id, nombre: nombre, descripcion: descripcion, precio: parseFloat(precio), imagen: imagen, cantidad_disponible: 0, cantidad_restante: 0};
        try {
            const url = `/api/producto/cantidad-disponible/?tipo=${tipo}&id=${id}`;
            const response = await fetch(url);
            if (!response.ok) {
                let errorMsg = `Error HTTP ${response.status}`;
                try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) { console.error('Error parsing:', e); }
                alert('Error al obtener disponibilidad: ' + errorMsg);
                return;
            }
            const data = await response.json();
            currentProduct.cantidad_disponible = data.cantidad_disponible || 0;
            let carrito = JSON.parse(sessionStorage.getItem('carrito') || '[]');
            let existente = carrito.find(item => item.tipo === tipo && item.id === id);
            let cantidadEnCarrito = existente ? existente.cantidad : 0;
            currentProduct.cantidad_restante = currentProduct.cantidad_disponible - cantidadEnCarrito;
            if (currentProduct.cantidad_disponible === 0) { alert('Este producto no est谩 disponible en inventario.'); return; }
            if (currentProduct.cantidad_restante <= 0) { alert(`Ya tienes todas las unidades disponibles (${currentProduct.cantidad_disponible}) en tu carrito.`); return; }
            document.getElementById('modalProductName').textContent = nombre;
            document.getElementById('modalProductDescription').textContent = descripcion;
            document.getElementById('modalProductPrice').textContent = precio;
            document.getElementById('modalImage').src = imagen;
            document.getElementById('quantity').value = 1;
            document.getElementById('quantity').max = currentProduct.cantidad_restante;
            const dispText = document.getElementById('disponibilidadText');
            if (cantidadEnCarrito > 0) {
                dispText.textContent = `Disponibles: ${currentProduct.cantidad_restante} unidades (${cantidadEnCarrito} ya en tu carrito)`;
                dispText.style.color = currentProduct.cantidad_restante < 5 ? '#ff9800' : '#28a745';
            } else {
                dispText.textContent = `Disponibles: ${currentProduct.cantidad_disponible} unidades`;
                dispText.style.color = currentProduct.cantidad_disponible < 5 ? '#ff9800' : '#28a745';
            }
            actualizarTotal();
            document.getElementById('productModal').style.display = 'block';
        } catch (error) {
            console.error('Error completo:', error);
            alert('Error al cargar la informaci贸n del producto: ' + error.message);
        }
    }
    function cerrarModal() { document.getElementById('productModal').style.display = 'none'; }
    function cambiarCantidad(delta) {
        let input = document.getElementById('quantity');
        let newValue = parseInt(input.value) + delta;
        let maxCantidad = currentProduct.cantidad_restante || 1;
        if (newValue < 1) return;
        if (newValue > maxCantidad) { alert(`Solo puedes agregar ${maxCantidad} unidades m谩s de este producto.`); return; }
        input.value = newValue;
        actualizarTotal();
    }
    function actualizarTotal() {
        let cantidad = parseInt(document.getElementById('quantity').value);
        let total = currentProduct.precio * cantidad;
        document.getElementById('totalPrice').textContent = total.toFixed(2);
    }
    async function agregarAlCarrito() {
        let cantidad = parseInt(document.getElementById('quantity').value);
        if (!currentProduct.tipo || !currentProduct.id) { alert('Error: Informaci贸n del producto no disponible'); return; }
        try {
            const response = await fetch(`/api/producto/cantidad-disponible/?tipo=${currentProduct.tipo}&id=${currentProduct.id}`);
            if (!response.ok) { alert('Error al verificar disponibilidad del producto. C贸digo: ' + response.status); return; }
            const data = await response.json();
            let carrito = JSON.parse(sessionStorage.getItem('carrito') || '[]');
            let existente = carrito.find(item => item.tipo === currentProduct.tipo && item.id === currentProduct.id);
            let cantidadEnCarrito = existente ? existente.cantidad : 0;
            let cantidadTotal = cantidadEnCarrito + cantidad;
            if (data.cantidad_disponible === 0) { alert('Este producto no est谩 disponible en inventario en este momento.'); return; }
            if (cantidadTotal > data.cantidad_disponible) { alert(`Solo hay ${data.cantidad_disponible} unidades disponibles en inventario. Ya tienes ${cantidadEnCarrito} en tu carrito.`); return; }
            if (existente) { existente.cantidad += cantidad; } 
            else { carrito.push({tipo: currentProduct.tipo, id: currentProduct.id, nombre: currentProduct.nombre, precio: currentProduct.precio, cantidad: cantidad, imagen: currentProduct.imagen, descripcion: currentProduct.descripcion}); }
            sessionStorage.setItem('carrito', JSON.stringify(carrito));
            updateCartBadge();
            alert('隆Producto agregado al carrito!');
            cerrarModal();
            if (confirm('驴Desea ir al carrito ahora?')) { window.location.href = '{% url "carrito" %}'; }
        } catch (error) { console.error('Error:', error); alert('Error al agregar el producto al carrito'); }
    }
    window.onclick = function(event) { let modal = document.getElementById('productModal'); if (event.target == modal) { cerrarModal(); } }
  function aplicarFiltros() {
        const categoria = document.getElementById('categoria').value;
        if (categoria) { window.location.href = '/' + categoria + '/'; } 
        else { window.location.href = '/productos/'; }
    }
    
    // Funci贸n para actualizar el badge del carrito
    function updateCartBadge() {
        // Actualizar bot贸n flotante si existe la funci贸n global
        if (typeof updateFloatingCartButton === 'function') {
            updateFloatingCartButton();
        }
    }
    
    // Actualizar badge al cargar la p谩gina
    document.addEventListener('DOMContentLoaded', function() {
        updateCartBadge();
    });
</script>

<script src="{% static 'core/javascript/Carrito.js' %}"></script>

{% include 'core/floating_buttons.html' %}
</body>
</html>