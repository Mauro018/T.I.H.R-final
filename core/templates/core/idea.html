<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tu Idea Hecha Realidad</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'core/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/idea.css' %}">
</head>
<body>

<!-- BARRA LATERAL (MENÚ + FILTROS) -->
<div class="sidebar">
    <div class="sidebar-user-info">
        <a href="{% url 'perfilUsuario' %}" class="user-avatar-link">
            {% if usuario.foto_perfil %}
                <img src="{{ usuario.foto_perfil.url }}" alt="Foto de perfil" width="50" height="50" style="border-radius: 50%; border: 2px solid #007BFF; object-fit: cover;">
            {% else %}
                <img src="{% static 'core/img/Perfil.png' %}" alt="Logo" width="50" height="50" style="border-radius: 50%; border: 2px solid #007BFF;">
            {% endif %}
        </a>
        <span class="username-display">{{ usuario.usernameCliente }}</span>
    </div>
  <h2 class="h2-side">Menú</h2>
  <ul>
    <li><a href="{% url 'productos' %}">Ofertas</a></li>
    <li><a href="{% url 'idea' %}">Crear Idea</a></li>
    <li><a href="{% url 'carrito' %}" style="position: relative;">
        Carrito
        <span id="cart-count-badge" class="cart-badge" style="display: none;">0</span>
    </a></li>
    <li><a href="{% url 'mis_pedidos' %}">Mis Pedidos</a></li>
    <li><a href="{% url 'contact' %}">Contáctenos</a></li>
    <li><a href="{% url 'comentarios' %}">Comentarios</a></li>
    <li><a href="{% url 'logout' %}" class="logout-button">Cerrar Sesión</a></li>
  </ul>

  <!-- FILTROS -->
  <div class="filtros">
    <h3>Filtrar productos</h3>

    <h2 for="categoria" class="h2-side">Categoría:</h2>
    <select id="categoria">
        <option value="">Elegir Categoria</option> 
        <option value="carpinteria">Armarios</option>
        <option value="marroquineria">Escritorios</option>
        <option value="vidrieria">Sillas</option>
        <option value="metaleria">Cajoneras</option>
        <option value="ceramica">Mesas</option>
        <option value="tapiceria">Utensilios</option>
    </select>

    <button onclick="aplicarFiltros()">Aplicar filtros</button>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="main-content-wrapper">
  <header>
    <h1 class="div" style="text-align: center;">
      <img src="{% static 'core/img/Gemini_Generated_Image_tzay6utzay6utzay.jfif' %}" alt="Logo" width="75" height="75">
      Tu Idea Hecha Realidad
    </h1>
  </header>

  <!-- Aquí va tu contenido: artículos, productos, etc. -->
   <section>
      <section class="seccion-at">
        <h2>Agregar una Nueva Idea a Crear</h2>
        <p>¿Tienes una idea que quieres desarrollar o compartir? Completa el siguiente formulario:</p>
        
        <form method="post" enctype="multipart/form-data" class="idea-form">
          {% csrf_token %}
          
          <!-- Título -->
          <div class="form-group">
            <label for="id_titulo">Título de tu idea:</label>
            {{ form.titulo }}
          </div>
          
          <!-- Descripción mejorada -->
          <div class="form-group">
            <label for="id_descripcion">Descripción detallada:</label>
            <textarea 
              name="descripcion" 
              id="id_descripcion" 
              placeholder="Describe tu idea detalladamente... ¿Qué quieres crear? ¿Qué características debería tener?"
              required
            >{{ form.descripcion.value|default:'' }}</textarea>
          </div>

          <!-- Imagen -->
          <div class="form-group">
            <label for="id_imagen">Adjuntar imagen (opcional):</label>
            {{ form.imagen }}
          </div>

          <!-- Modelo 3D -->
          <div class="form-group">
            <label for="id_modelo_3d">Adjuntar Modelo 3D .glb (opcional):</label>
            {{ form.modelo_3d }}
            <small class="form-text">Formatos aceptados: .glb</small>
          </div>
          
          <button type="submit" class="articulo-boton">Publicar Idea</button>
        </form>
      </section>
      <br>
      
      <!-- Sección de Mis Ideas -->
      {% if mis_ideas %}
      <section class="seccion-at">
        <h2>Mis Ideas</h2>
        <div class="contenedor-articulos">
          {% for idea in mis_ideas %}
            <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% elif idea.estado == 'finalizada' %}finalizada{% endif %}" style="{% if idea.estado == 'finalizada' %}border-left: 4px solid #6f42c1;{% endif %}">
              <div class="contenido-articulo">
                <h3>{{ idea.titulo }}</h3>
                <p>{{ idea.descripcion }}</p>
                <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                {% if idea.empresa_asignada %}
                <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                {% endif %}
                
                <!-- Mensaje de la empresa -->
                {% if idea.mensaje_empresa %}
                <div class="mensaje-empresa" style="background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007BFF;">
                  <h4 style="color: #007BFF; margin-top: 0;">Mensaje de la Empresa:</h4>
                  <p>{{ idea.mensaje_empresa }}</p>
                  
                  {% if not idea.respuesta_cliente %}
                  <button onclick="responderEmpresa({{ idea.id }})" class="articulo-boton" style="margin-top: 10px; padding: 8px 15px;">
                    Responder
                  </button>
                  {% else %}
                  <div style="background-color: #d4edda; padding: 10px; border-radius: 6px; margin-top: 10px;">
                    <strong style="color: #155724;">Tu respuesta:</strong>
                    <p style="margin: 5px 0 0 0; color: #155724;">{{ idea.respuesta_cliente }}</p>
                  </div>
                  {% endif %}
                </div>
                {% endif %}
                
                <!-- Permiso de publicación -->
                {% if idea.estado == 'finalizada' %}
                <div class="permiso-publicacion" style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                  {% if not idea.permiso_publicacion %}
                  <h4 style="color: #856404; margin-top: 0;">¿Permitir publicar tu idea como producto?</h4>
                  <p style="color: #856404;">La empresa te solicita permiso para publicar tu idea como un producto en la tienda.</p>
                  <button onclick="otorgarPermiso({{ idea.id }})" class="articulo-boton" style="background-color: #28a745; margin-top: 10px; padding: 8px 15px;">
                    ✓ Otorgar Permiso
                  </button>
                  {% else %}
                  <div style="background-color: #d4edda; padding: 10px; border-radius: 6px;">
                    <strong style="color: #155724;">✓ Permiso Otorgado</strong>
                    <p style="margin: 5px 0 0 0; color: #155724;">Fecha: {{ idea.fecha_permiso|date:"d/m/Y H:i" }}</p>
                    {% if not idea.publicada_como_producto %}
                    <button onclick="revocarPermiso({{ idea.id }})" class="articulo-boton" style="background-color: #dc3545; margin-top: 10px; padding: 6px 12px; font-size: 0.9rem;">
                      Revocar Permiso
                    </button>
                    {% else %}
                    <p style="margin: 10px 0 0 0; color: #0c5460; font-weight: bold;">✓ Ya fue publicada como producto</p>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
      <br>
      {% endif %}
      
      <section class="seccion-at">
        <h2>Ideas Publicadas</h2>
        {% if ideas %}
          <div class="contenedor-articulos">
            {% for idea in ideas %}
              <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% endif %}">
                <div class="contenido-articulo">
                  <!-- Header con avatar y nombre del autor -->
                  <div class="idea-header">
                    <div class="idea-usuario">
                      <div class="usuario-avatar">
                        {% if idea.usuario.foto_perfil %}
                          <img src="{{ idea.usuario.foto_perfil.url }}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                          <img src="{% static 'core/img/Perfil.png' %}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% endif %}
                      </div>
                      <div class="usuario-info">
                        <h4>{{ idea.autor }}</h4>
                        <span class="idea-fecha">{{ idea.fecha_creacion|date:"d/m/Y H:i" }}</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contenido de la idea -->
                  <h3>{{ idea.titulo }}</h3>
                  <p>{{ idea.descripcion }}</p>
                  <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                  {% if idea.empresa_asignada %}
                  <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>Aún no hay ideas publicadas. ¡Sé el primero en compartir la tuya!</p>
        {% endif %}
      </section>
  </section>


  <footer>
    <p>&copy; 2025 Tu Idea Hecha Realidad</p>
  </footer>
</div>

<script src="{% static 'core/javascript/Carrito.js' %}"></script>
<script>
  function aplicarFiltros() {
        const categoria = document.getElementById('categoria').value;
        console.log('Aplicando filtros y redirigiendo...');
        console.log('Categoría seleccionada:', categoria);

        if (categoria) {
            const urlRedireccion = '/' + categoria + '/';
            
            console.log('Redirigiendo a:', urlRedireccion);
            window.location.href = urlRedireccion;
        } else {
            window.location.href = '/productos/'; 
        }
    }

  // Función para responder a la empresa
  function responderEmpresa(ideaId) {
    const respuesta = prompt('Escribe tu respuesta a la empresa:');
    if (respuesta && respuesta.trim()) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const formData = new FormData();
      formData.append('respuesta', respuesta.trim());
      
      fetch(`/idea/responder/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la respuesta');
      });
    }
  }

  // Función para otorgar permiso de publicación
  function otorgarPermiso(ideaId) {
    if (confirm('¿Estás seguro de que deseas otorgar permiso a la empresa para publicar tu idea como producto en la tienda?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/otorgar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al otorgar el permiso');
      });
    }
  }

  // Función para revocar permiso de publicación
  function revocarPermiso(ideaId) {
    if (confirm('¿Estás seguro de que deseas revocar el permiso de publicación?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/revocar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al revocar el permiso');
      });
    }
  }
</script>

</body>
</html>