<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tu Idea Hecha Realidad</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'core/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/idea.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/responsive.css' %}">
</head>
<body>

<!-- BARRA LATERAL (MENÃš + FILTROS) -->
<div class="sidebar">
    <div class="sidebar-user-info">
        <a href="{% url 'perfilUsuario' %}" class="user-avatar-link">
            {% if usuario.foto_perfil %}
                <img src="{{ usuario.foto_perfil.url }}" alt="Foto de perfil" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F; object-fit: cover;">
            {% else %}
                <img src="{% static 'core/img/Perfil.png' %}" alt="Logo" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F;">
            {% endif %}
        </a>
        <span class="username-display">{{ usuario.usernameCliente }}</span>
    </div>
  <ul>
    <li><a href="{% url 'productos' %}">Ofertas</a></li>
    <li><a href="{% url 'idea' %}">Crear Idea</a></li>
    <li><a href="{% url 'mis_pedidos' %}">Mis Pedidos</a></li>
    <li><a href="{% url 'contact' %}">ContÃ¡ctenos</a></li>
    <li><a href="{% url 'comentarios' %}">Comentarios</a></li>
    <li><a href="{% url 'logout' %}" class="logout-button">Cerrar SesiÃ³n</a></li>
  </ul>

  <!-- FILTROS -->
  <div class="filtros">
    <h2 for="categoria" class="h2-side">CategorÃ­a:</h2>
    <select id="categoria">
        <option value="">Elegir Categoria</option> 
        <option value="carpinteria">Armarios</option>
        <option value="marroquineria">Escritorios</option>
        <option value="vidrieria">Sillas</option>
        <option value="metaleria">Cajoneras</option>
        <option value="ceramica">Mesas</option>
        <option value="tapiceria">Utensilios</option>
    </select>

    <button onclick="aplicarFiltros()">Aplicar filtros</button>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="main-content-wrapper">
  <header>
    <h1 class="div" style="text-align: center;">
      <img src="{% static 'core/img/Gemini_Generated_Image_tzay6utzay6utzay.jfif' %}" alt="Logo" width="75" height="75">
      Tu Idea Hecha Realidad
    </h1>
  </header>

  <!-- AquÃ­ va tu contenido: artÃ­culos, productos, etc. -->
   <section>
      <section class="seccion-at">
        <h2>Agregar una Nueva Idea a Crear</h2>
        <p>Â¿Tienes una idea que quieres desarrollar o compartir? Completa el siguiente formulario:</p>
        
        <form method="post" enctype="multipart/form-data" class="idea-form">
          {% csrf_token %}
          
          <!-- TÃ­tulo -->
          <div class="form-group">
            <label for="id_titulo">TÃ­tulo de tu idea:</label>
            {{ form.titulo }}
          </div>
          
          <!-- DescripciÃ³n mejorada -->
          <div class="form-group">
            <label for="id_descripcion">DescripciÃ³n detallada:</label>
            <textarea 
              name="descripcion" 
              id="id_descripcion" 
              placeholder="Describe tu idea detalladamente... Â¿QuÃ© quieres crear? Â¿QuÃ© caracterÃ­sticas deberÃ­a tener?"
              required
            >{{ form.descripcion.value|default:'' }}</textarea>
          </div>

          <!-- Imagen -->
          <div class="form-group">
            <label for="id_imagen">Adjuntar imagen (opcional):</label>
            {{ form.imagen }}
          </div>

          <!-- Modelo 3D -->
          <div class="form-group">
            <label for="id_modelo_3d">Adjuntar Modelo 3D .glb (opcional):</label>
            {{ form.modelo_3d }}
            <small class="form-text">Formatos aceptados: .glb</small>
          </div>
          
          <button type="submit" class="articulo-boton">Publicar Idea</button>
        </form>
      </section>
      <br>
      
      <!-- SecciÃ³n de Mis Ideas -->
      {% if mis_ideas %}
      <section class="seccion-at">
        <h2>Mis Ideas</h2>
        <div class="contenedor-articulos">
          {% for idea in mis_ideas %}
            <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% elif idea.estado == 'finalizada' %}finalizada{% endif %}" style="{% if idea.estado == 'finalizada' %}border-left: 4px solid #6f42c1;{% endif %}">
              <div class="contenido-articulo">
                <h3>{{ idea.titulo }}</h3>
                <p>{{ idea.descripcion }}</p>
                <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                {% if idea.empresa_asignada %}
                <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                {% endif %}
                
                <!-- Los mensajes y permisos ahora se manejan en el modal de notificaciones -->
                
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
      <br>
      {% endif %}
      
      <section class="seccion-at">
        <h2>Ideas Publicadas</h2>
        {% if ideas %}
          <div class="contenedor-articulos">
            {% for idea in ideas %}
              <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% endif %}">
                <div class="contenido-articulo">
                  <!-- Header con avatar y nombre del autor -->
                  <div class="idea-header">
                    <div class="idea-usuario">
                      <div class="usuario-avatar">
                        {% if idea.usuario.foto_perfil %}
                          <img src="{{ idea.usuario.foto_perfil.url }}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                          <img src="{% static 'core/img/Perfil.png' %}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% endif %}
                      </div>
                      <div class="usuario-info">
                        <h4>{{ idea.autor }}</h4>
                        <span class="idea-fecha">{{ idea.fecha_creacion|date:"d/m/Y" }}</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contenido de la idea -->
                  <h3>{{ idea.titulo }}</h3>
                  <p>{{ idea.descripcion }}</p>
                  <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                  {% if idea.empresa_asignada %}
                  <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>AÃºn no hay ideas publicadas. Â¡SÃ© el primero en compartir la tuya!</p>
        {% endif %}
      </section>
  </section>


  <footer>
    <div class="footer-content">
        <div class="footer-section">
            <h3 class="footer-title">ğŸ“ ContÃ¡ctenos</h3>
            <div class="footer-info">
                <i>ğŸ“</i>
                <span>+57 300 123 4567</span>
            </div>
            <div class="footer-info">
                <i>âœ‰ï¸</i>
                <span>info@gangasca-tirr.com</span>
            </div>
        </div>
        
        <div class="footer-section">
            <h3 class="footer-title">ğŸ“ DirecciÃ³n</h3>
            <div class="footer-info">
                <i>ğŸ“</i>
                <span>Carrera 45 P. 26-85<br>RoyalA, Colombia</span>
            </div>
        </div>
        
        <div class="footer-section">
            <h3 class="footer-title">ğŸŒ SÃ­guenos</h3>
            <div class="footer-social">
                <div class="social-container">
                    <a href="https://www.instagram.com/tu_idea_hecha_realidad?igsh=Y3ByM2lyZGcwNHVy" class="social-icon" aria-label="Instagram">
                        <span>ğŸ“·</span>
                    </a>
                    <div class="social-username">@Gangazos Thir</div>
                </div>
                <div class="social-container">
                    <a href="https://www.facebook.com/share/1ACEVZbZHV/" class="social-icon" aria-label="Facebook">
                        <span>ğŸ“˜</span>
                    </a>
                    <div class="social-username">/gangazoz_thir</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-bottom">
        <p>Â© 2025 Tu Idea Herba Realidad - Todos los derechos reservados</p>
    </div>
  </footer>
</div>

<script src="{% static 'core/javascript/Carrito.js' %}"></script>
<script>
  function aplicarFiltros() {
        const categoria = document.getElementById('categoria').value;
        console.log('Aplicando filtros y redirigiendo...');
        console.log('CategorÃ­a seleccionada:', categoria);

        if (categoria) {
            const urlRedireccion = '/' + categoria + '/';
            
            console.log('Redirigiendo a:', urlRedireccion);
            window.location.href = urlRedireccion;
        } else {
            window.location.href = '/productos/'; 
        }
    }

  // FunciÃ³n para responder a la empresa
  function responderEmpresa(ideaId) {
    const respuesta = prompt('Escribe tu respuesta a la empresa:');
    if (respuesta && respuesta.trim()) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const formData = new FormData();
      formData.append('respuesta', respuesta.trim());
      
      fetch(`/idea/responder/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la respuesta');
      });
    }
  }

  // FunciÃ³n para otorgar permiso de publicaciÃ³n
  function otorgarPermiso(ideaId) {
    if (confirm('Â¿EstÃ¡s seguro de que deseas otorgar permiso a la empresa para publicar tu idea como producto en la tienda?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/otorgar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al otorgar el permiso');
      });
    }
  }

  // FunciÃ³n para revocar permiso de publicaciÃ³n
  function revocarPermiso(ideaId) {
    if (confirm('Â¿EstÃ¡s seguro de que deseas revocar el permiso de publicaciÃ³n?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/revocar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al revocar el permiso');
      });
    }
  }
</script>

<script src="{% static 'core/javascript/sidebar-toggle.js' %}"></script>
{% include 'core/floating_buttons.html' %}
{% include 'core/modal_notificaciones.html' %}
</body>
</html>