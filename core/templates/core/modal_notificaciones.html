{% load static %}
<link rel="stylesheet" href="{% static 'core/css/notificaciones.css' %}">

<!-- Modal de Notificaciones -->
<div id="notificacionesModal" class="notif-modal">
    <div class="notif-modal-content">
        <!-- Header del Modal -->
        <div class="notif-modal-header">
            <h3>Notificaciones</h3>
            <button class="notif-close" onclick="cerrarNotificaciones()">&times;</button>
        </div>
        
        <!-- Lista de Conversaciones -->
        <div id="conversacionesLista" class="conversaciones-lista">
            <!-- Se cargar√° din√°micamente -->
        </div>
        
        <!-- Vista de Chat Individual -->
        <div id="chatContainer" class="chat-container">
            <div class="chat-header">
                <button class="chat-back-btn" onclick="volverAConversaciones()">‚Üê</button>
                <div class="chat-info">
                    <h4 id="chatTitulo"></h4>
                    <p id="chatEstado"></p>
                </div>
            </div>
            
            <div id="chatMensajes" class="chat-mensajes">
                <!-- Mensajes se cargar√°n aqu√≠ -->
            </div>
            
            <div class="chat-input-container">
                <form id="chatForm" class="chat-input-form" onsubmit="enviarMensaje(event)">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Escribe tu mensaje..."
                        rows="1"
                        required
                    ></textarea>
                    <button type="submit" class="chat-send-btn">
                        ‚û§
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let ideasConMensajes = [];
let ideaActualChat = null;
let usernameEmpresa = '{{ request.session.usernameEmpresa|default:"" }}';
let usernameCliente = '{{ request.session.usernameCliente|default:"" }}';
let tipoUsuario = usernameEmpresa && usernameEmpresa !== '' ? 'empresa' : 'cliente';
let nombreUsuario = usernameEmpresa || usernameCliente;

console.log('Username Empresa:', usernameEmpresa);
console.log('Username Cliente:', usernameCliente);
console.log('Tipo de usuario:', tipoUsuario);
console.log('Nombre usuario:', nombreUsuario);

// Abrir modal de notificaciones
function abrirNotificaciones() {
    document.getElementById('notificacionesModal').style.display = 'block';
    cargarConversaciones();
}

// Cerrar modal
function cerrarNotificaciones() {
    document.getElementById('notificacionesModal').style.display = 'none';
    document.getElementById('conversacionesLista').style.display = 'block';
    document.getElementById('chatContainer').style.display = 'none';
}

// Cerrar al hacer clic fuera del modal
window.onclick = function(event) {
    const modal = document.getElementById('notificacionesModal');
    if (event.target === modal) {
        cerrarNotificaciones();
    }
}

// Cargar lista de conversaciones (ideas con mensajes)
function cargarConversaciones() {
    console.log('Cargando conversaciones...');
    fetch('/api/conversaciones/', {
        credentials: 'same-origin'  // Importante: incluir cookies de sesi√≥n
    })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('=== DATA RECIBIDA ===');
            console.log('Objeto completo:', data);
            console.log('data.success:', data.success);
            console.log('data.conversaciones:', data.conversaciones);
            console.log('Es array?:', Array.isArray(data.conversaciones));
            if (data.conversaciones) {
                console.log('Length:', data.conversaciones.length);
            }
            
            if (data.success && data.conversaciones) {
                ideasConMensajes = data.conversaciones;
                console.log('‚úÖ Conversaciones asignadas a ideasConMensajes:', ideasConMensajes.length);
                console.log('Primera conversaci√≥n:', ideasConMensajes[0]);
            } else {
                ideasConMensajes = [];
                console.log('‚ùå No se encontraron conversaciones o success=false');
            }
            
            console.log('Llamando mostrarConversaciones con', ideasConMensajes.length, 'items');
            mostrarConversaciones();
        })
        .catch(error => {
            console.error('Error al cargar conversaciones:', error);
            ideasConMensajes = [];
            mostrarConversaciones();
        });
}

// Mostrar lista de conversaciones
function mostrarConversaciones() {
    console.log('=== MOSTRAR CONVERSACIONES ===');
    console.log('ideasConMensajes:', ideasConMensajes);
    console.log('Length:', ideasConMensajes.length);
    
    const lista = document.getElementById('conversacionesLista');
    
    if (ideasConMensajes.length === 0) {
        console.log('‚ö†Ô∏è Mostrando mensaje "No tienes conversaciones"');
        lista.innerHTML = `
            <div class="no-conversaciones">
                <div class="no-conversaciones-icono">üì≠</div>
                <p>No tienes conversaciones</p>
            </div>
        `;
        return;
    }
    
    console.log('‚úÖ Renderizando', ideasConMensajes.length, 'conversaciones');
    lista.innerHTML = ideasConMensajes.map(idea => {
        const tieneNoLeidos = idea.mensajes_no_leidos > 0;
        const estadoColor = idea.estado === 'finalizada' ? 'completada' : 'pendiente';
        const ultimoMensaje = idea.ultimo_mensaje || 'Sin mensajes';
        const tieneSolicitudPermiso = idea.tiene_solicitud_permiso && !idea.permiso_otorgado;
        const nombreOtro = idea.otro_participante || 'Desconocido';
        
        return `
            <div class="conversacion-item ${tieneNoLeidos ? 'no-leido' : ''}" 
                 onclick="abrirChat(${idea.id})">
                <div class="conversacion-titulo">
                    <strong>${idea.titulo}</strong>
                    <span class="conversacion-estado ${estadoColor}">
                        ${idea.estado}
                    </span>
                </div>
                <div style="font-size: 0.85rem; color: #666; margin: 3px 0;">
                    ${tipoUsuario === 'cliente' ? 'Empresa' : 'Cliente'}: <strong>${nombreOtro}</strong>
                </div>
                <div class="conversacion-ultimo-mensaje">${ultimoMensaje}</div>
                <div class="conversacion-fecha">${idea.ultima_actualizacion}</div>
                ${tieneSolicitudPermiso ? '<div class="badge-permiso">Solicitud de permiso pendiente</div>' : ''}
            </div>
        `;
    }).join('');
}

// Abrir chat individual
function abrirChat(ideaId) {
    ideaActualChat = ideaId;
    const idea = ideasConMensajes.find(i => i.id === ideaId);
    
    if (!idea) return;
    
    document.getElementById('conversacionesLista').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'flex';
    document.getElementById('chatTitulo').textContent = idea.titulo;
    
    const nombreOtro = idea.otro_participante || 'Desconocido';
    const tipoOtro = tipoUsuario === 'cliente' ? 'Empresa' : 'Cliente';
    document.getElementById('chatEstado').textContent = `${tipoOtro}: ${nombreOtro} | Estado: ${idea.estado}`;
    
    cargarMensajes(ideaId);
    marcarMensajesComoLeidos(ideaId);
}

// Volver a la lista de conversaciones
function volverAConversaciones() {
    document.getElementById('conversacionesLista').style.display = 'block';
    document.getElementById('chatContainer').style.display = 'none';
    ideaActualChat = null;
    cargarConversaciones(); // Recargar para actualizar contadores
}

// Cargar mensajes de una idea
function cargarMensajes(ideaId) {
    fetch(`/api/mensajes-idea/${ideaId}/`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            mostrarMensajes(data.mensajes, data.idea);
        })
        .catch(error => {
            console.error('Error al cargar mensajes:', error);
        });
}

// Mostrar mensajes en el chat
function mostrarMensajes(mensajes, idea) {
    const chatMensajes = document.getElementById('chatMensajes');
    
    console.log('=== MOSTRAR MENSAJES ===');
    console.log('Total mensajes:', mensajes.length);
    console.log('Idea:', idea);
    console.log('Permiso otorgado:', idea.permiso_otorgado);
    console.log('Tipo usuario:', tipoUsuario);
    
    if (mensajes.length === 0) {
        chatMensajes.innerHTML = `
            <div class="no-conversaciones">
                <p>No hay mensajes a√∫n. ¬°Inicia la conversaci√≥n!</p>
            </div>
        `;
        return;
    }
    
    chatMensajes.innerHTML = mensajes.map(msg => {
        const esPermiso = msg.es_solicitud_permiso;
        const permisoOtorgado = idea.permiso_otorgado;
        
        console.log('Mensaje:', {
            es_solicitud_permiso: esPermiso,
            permiso_otorgado: permisoOtorgado,
            tipo_usuario: tipoUsuario,
            mostrar_botones: !permisoOtorgado && tipoUsuario === 'cliente'
        });
        
        if (esPermiso) {
            const mostrarBotones = !permisoOtorgado && tipoUsuario === 'cliente';
            console.log('üîç PERMISO DETECTADO:');
            console.log('  - permisoOtorgado:', permisoOtorgado);
            console.log('  - tipoUsuario:', tipoUsuario);
            console.log('  - mostrarBotones:', mostrarBotones);
            
            return `
                <div class="mensaje solicitud-permiso-container">
                    <div class="mensaje-bubble mensaje-permiso ${permisoOtorgado ? 'permiso-otorgado' : ''}">
                        <div class="permiso-header">
                            <div class="permiso-titulo">Solicitud de Permiso de Publicaci√≥n</div>
                        </div>
                        <div class="mensaje-texto permiso-descripcion">${msg.mensaje}</div>
                        <div class="mensaje-fecha">${msg.fecha_envio}</div>
                        <div class="permiso-botones">
                            <button class="btn-aceptar-permiso" onclick="aceptarPermiso(${idea.id})" ${permisoOtorgado ? 'disabled' : ''}>
                                Aceptar
                            </button>
                            <button class="btn-rechazar-permiso" onclick="rechazarPermiso(${idea.id})" ${permisoOtorgado ? 'disabled' : ''}>
                                Rechazar
                            </button>
                        </div>
                        ${permisoOtorgado ? `
                            <div class="permiso-otorgado-badge">
                                Permiso otorgado${idea.fecha_permiso ? ' el ' + idea.fecha_permiso : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        return `
            <div class="mensaje ${msg.remitente_tipo}">
                <div class="mensaje-bubble">
                    <div class="mensaje-autor">${msg.remitente_nombre}</div>
                    <div class="mensaje-texto">${msg.mensaje}</div>
                    <div class="mensaje-fecha">${msg.fecha_envio}</div>
                </div>
            </div>
        `;
    }).join('');
    
    // Scroll al final despu√©s de renderizar
    setTimeout(() => {
        chatMensajes.scrollTop = chatMensajes.scrollHeight;
        console.log('Scroll realizado. Altura:', chatMensajes.scrollHeight);
    }, 100);
}

// Enviar mensaje
function enviarMensaje(event) {
    event.preventDefault();
    
    const input = document.getElementById('chatInput');
    const mensaje = input.value.trim();
    
    if (!mensaje || !ideaActualChat) return;
    
    const formData = new FormData();
    formData.append('mensaje', mensaje);
    
    fetch(`/api/enviar-mensaje/${ideaActualChat}/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            cargarMensajes(ideaActualChat);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el mensaje');
    });
}

// Aceptar permiso de publicaci√≥n
function aceptarPermiso(ideaId) {
    if (!confirm('¬øEst√°s seguro de otorgar permiso a la empresa para publicar tu idea como producto?')) {
        return;
    }
    
    fetch(`/idea/otorgar-permiso/${ideaId}/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Permiso otorgado exitosamente');
            cargarMensajes(ideaId);
            cargarConversaciones(); // Actualizar la lista
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al otorgar el permiso');
    });
}

// Rechazar permiso de publicaci√≥n
function rechazarPermiso(ideaId) {
    if (!confirm('¬øEst√°s seguro de rechazar la solicitud de permiso?')) {
        return;
    }
    
    // Enviar mensaje indicando el rechazo
    const formData = new FormData();
    formData.append('mensaje', '‚ùå He rechazado la solicitud de permiso de publicaci√≥n.');
    
    fetch(`/api/enviar-mensaje/${ideaId}/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Solicitud rechazada');
            cargarMensajes(ideaId);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al rechazar el permiso');
    });
}

// MANTENER COMPATIBILIDAD: Alias de aceptarPermiso
function otorgarPermisoChat(ideaId) {
    aceptarPermiso(ideaId);
}

// Marcar mensajes como le√≠dos
function marcarMensajesComoLeidos(ideaId) {
    fetch(`/api/marcar-leidos/${ideaId}/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .catch(error => console.error('Error al marcar como le√≠dos:', error));
}

// Obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-resize del textarea
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    }
});
</script>
